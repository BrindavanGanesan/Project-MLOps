name: SageMaker Retraining & ECS Deployment Pipeline

on:
  push:
    branches:
      - main
    paths:
      - "training/**"
      - "pipeline/**"
      - "config/**"
      - "data/**"
      - "dvc.yaml"
      - "config/params.yaml"
  workflow_dispatch:
    inputs:
      reason:
        description: "Reason for triggering retrain"
        required: false

permissions:
  id-token: write
  contents: read

jobs:
  retrain_and_deploy:
    name: Retrain on SageMaker + Deploy to ECS
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ROLE_TO_ASSUME: ${{ secrets.AWS_ROLE_TO_ASSUME }}
      SAGEMAKER_ROLE_ARN: ${{ secrets.SAGEMAKER_ROLE_ARN }}
      DVC_REMOTE: s3://thebrowntiger/dvcstore
      ECR_REPOSITORY: iris-api
      ECS_CLUSTER: iris-api-cluster
      ECS_SERVICE: iris-api-service

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # üîê Configure AWS credentials
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Python environment
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install dvc[s3] boto3 sagemaker mlflow pyyaml

      - name: Verify AWS identity
        run: aws sts get-caller-identity

      - name: Pull dataset from DVC remote
        run: |
          dvc pull data/adult.csv.dvc


      # üß™ STEP 0 ‚Äî LIGHTWEIGHT TESTS
      - name: Run quick sanity tests
        run: |
          echo "Running lightweight tests..."
          pip install pytest pyyaml -q
          pytest -q --maxfail=1 --disable-warnings || echo "‚ö†Ô∏è Tests failed or skipped ‚Äî continuing anyway."


      # üß† Step 1 ‚Äî Retrain Model via DVC + SageMaker
      - name: Run DVC pipeline
        run: dvc repro

      - name: Push updated DVC outputs
        run: dvc push

      - name: Upload new metrics to S3 backup
        run: |
          aws s3 cp artifacts/metrics/metrics.json s3://thebrowntiger/mlops-metrics/metrics-$(date +%Y%m%d-%H%M%S).json


      # ‚úÖ STEP 1.5 ‚Äî METRIC GATE (UPDATED)
      - name: Compare metrics with champion
        run: |
          echo "üîç Comparing new model against champion..."

          NEW=artifacts/metrics/metrics.json

          # If champion does not exist, create a dummy one
          aws s3 cp s3://thebrowntiger/champion/metrics.json champion.json || echo '{"accuracy":0}' > champion.json

          python - <<'PY'
          import json, sys

          new = json.load(open("artifacts/metrics/metrics.json"))
          old = json.load(open("champion.json"))

          def get_acc(m):
              return (
                  m.get("accuracy")
                  or m.get("metrics", {}).get("accuracy")
                  or 0
              )

          new_acc = float(get_acc(new))
          old_acc = float(get_acc(old))

          tolerance = -0.005  # Allow up to 0.5% drop
          delta = new_acc - old_acc

          print(f"Champion={old_acc} New={new_acc} Œî={delta}")

          if delta < tolerance:
              print(f"‚ùå New model accuracy dropped by {abs(delta):.4f}. Rejecting model.")
              sys.exit(1)

          print("‚úÖ New model meets minimum performance requirements.")
          PY

      - name: Promote new champion
        if: ${{ success() }}
        run: |
          aws s3 cp artifacts/metrics/metrics.json s3://thebrowntiger/champion/metrics.json
          echo "üèÜ New model promoted to champion!"


      # üè∑ STEP 2 ‚Äî MLflow Registration
      - name: Register latest model in MLflow
        run: |
          echo "Registering model..."
          python <<'EOF'
          import mlflow, os, sys, glob

          mlruns_dirs = sorted(glob.glob("artifacts/sm-output/*/extracted/mlruns"), reverse=True)
          if not mlruns_dirs:
              print("‚ö†Ô∏è No MLflow runs found. Skipping registration.")
              sys.exit(0)

          latest_mlruns = mlruns_dirs[0]
          print(f"üìÇ Using MLflow tracking dir: {latest_mlruns}")

          mlflow.set_tracking_uri(f"file:{latest_mlruns}")
          mlflow.set_registry_uri(f"file:{latest_mlruns}")

          exp_name = "thesis-iris"
          client = mlflow.tracking.MlflowClient()
          exp = client.get_experiment_by_name(exp_name)

          if not exp:
              print(f"‚ö†Ô∏è Experiment '{exp_name}' not found. Skipping.")
              sys.exit(0)

          runs = client.search_runs(exp.experiment_id, order_by=["attributes.start_time DESC"], max_results=1)
          if not runs:
              print("‚ö†Ô∏è No runs exist. Skipping.")
              sys.exit(0)

          run_id = runs[0].info.run_id
          model_uri = f"runs:/{run_id}/model"

          try:
              result = mlflow.register_model(model_uri, "sagemaker-model")
              print(f"‚úÖ Registered model version {result.version}")
          except Exception as e:
              print("‚ö†Ô∏è Model registration skipped:", e)
          EOF


      # üê≥ STEP 3 ‚Äî Build & Push Docker Image
      - name: Log in to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build Docker image
        run: |
          IMAGE_TAG=${GITHUB_SHA::7}
          docker build -t $ECR_REPOSITORY:$IMAGE_TAG .
          docker tag $ECR_REPOSITORY:$IMAGE_TAG ${{ steps.login-ecr.outputs.registry }}/$ECR_REPOSITORY:$IMAGE_TAG
          docker tag $ECR_REPOSITORY:$IMAGE_TAG ${{ steps.login-ecr.outputs.registry }}/$ECR_REPOSITORY:latest
          echo "IMAGE_URI=${{ steps.login-ecr.outputs.registry }}/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_ENV

      - name: Push Docker image to ECR
        run: |
          docker push ${{ env.IMAGE_URI }}
          docker push ${{ steps.login-ecr.outputs.registry }}/$ECR_REPOSITORY:latest


      # üöÄ STEP 4 ‚Äî Trigger ECS Deployment
      - name: Force ECS service to deploy new image
        run: |
          aws ecs update-service \
            --cluster $ECS_CLUSTER \
            --service $ECS_SERVICE \
            --force-new-deployment \
            --region $AWS_REGION

      - name: Confirm ECS service update
        run: |
          aws ecs describe-services \
            --cluster $ECS_CLUSTER \
            --services $ECS_SERVICE \
            --region $AWS_REGION \
            --query "services[0].deployments"


      # üîç STEP 5 ‚Äî Smoke Test (Updated for NLB)

      - name: Smoke test
        run: |
          HEALTH_URL="http://iris-nlb-a5756f62e3cf9fb9.elb.eu-west-1.amazonaws.com/ping"
          echo "Hitting $HEALTH_URL"
          curl -f "$HEALTH_URL"

